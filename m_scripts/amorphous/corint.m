function [icor,cor] = corint(k,data,bkgd,imult,energy,pol,sample,mu,beam,geo);% CORINT Correct intensity for absorption, polarization, and multiple scattering.%% Usage: [icor,cor] = corint(k,data,bkgd,imult,energy,pol,sample,mu,beam,geo);%% Input:%   k       = Array of scattering vector magnitudes (inv. Angstoms)%   data    = measured intensity data (raw, arbitrary units)%   bkgd    = background intensity (use empty array, [], if unknown or zero)%   imult   = array of I(multiple)/I(single). You can use MULTIPLE.M for this%             (Warren's method) or calculate it on your own. Use an empty array, [],%             to neglect multple scattering.%   energy  = x-ray energy (eV)%   pol     = polarization constant. If empty ([]), then no polarization correction%             is applied. Otherwise, it is defined as follows:%             (1) If pol=0, then it is assumed that the incident radiation%                 is unpolarized (as from a laboratory source) and that %                 there is no monochromator.%             (2) If pol>0, then it is assumed that the incident radiation%                 is unpolarized and that there is an exit-beam monochromator. %                 In this case, calculate pol using pol=cos(2theta_mon)^2 for an %                 ideally imperfect monochromator crystal, and pol=abs(cos(2theta_mon)) %                 for an ideally perfect crystal (where 2theta_mon is the scattering %                 angle of the monochromator).%             (3) If pol<0, then it is assumed that a synchrotron source is%                 being used, with scattering in the vertical plane. In%                 this case, abs(pol) is the fraction horizontal polarization%                 of the synchrotron beam (probably around 0.95, but ask your%                 local guru).%   sample  = sample data array, as follows: %             sample(1) = thickness of sample (cm)%             sample(2) = density (g/cm^3)%             sample(3) = atomic density (atoms/^3)%   mu      = linear absorption coefficient (1/cm)%   beam    = beam geometry array, as follows:%               beam(1) = height of incident beam (cm)%               beam(2) = detector slit opening (cm)%               beam(3) = sample offset (degrees), (=0 for symmetric)%   geo     = sample geometry string. Possibilities:%             Reflection geometry:%               'reflthick' Symmetric or asymmetric reflection%               'reflthin'  Symmetric reflection (weakly absorbing sample) %             Transmission geometry:%               'trans'     Symmetric or asymmetric transmission geometry%               'transpart' Symmetric geometry, detector height included%               'transnorm' Transmission with incident beam perpendicular to sample%             Electron scattering:%               'tem'       Electron scattering in transmission (TEM)%% Output:%   icor    = corrected intensity%   cor     = correction factor (as function of k)%% Copyright 2000, Todd Hufnagel (hufnagel@jhu.edu)% TCH 1-15-94% Note that this replaces the call to MULCOR in WAXS% TCH 3-29-95 Made the polarization correction option% TCH 7-27-99 Automatically reshape input vectors to row vectors% TCH 5-2-00 Code clean-up; use same k-scale for multiple scattering as data% TCH 09-May-03 More code clean-up; incoportate MULCOR (and related files) directly into% this file. Added code for PROBE flag.% Check which radiation we're using; x-rays (PROBE=0) are the default   global PROBE     if isempty(PROBE) PROBE=0;end   if ~((PROBE==0)|(PROBE==1))       error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   end  % If background not given, make it zero  if (isempty(bkgd)==1) bkgd=zeros(size(k));end;% If multiple scattering not given, make it zero  if (isempty(imult)==1) imult=zeros(size(k));end;% Use column vectors  k=k(:);  data=data(:);  bkgd=bkgd(:);  imult=imult(:);% Extract pertinent data  thick=sample(1);  bin=beam(1);  bout=beam(2);  alpha=beam(3);  geo=lower(geo);  % Calculate scattering angle   switch PROBE       case 0                   % x-rays           t = ktotheta(k,energy,'xe');       case 1                   % electrons           t = ktotheta(k,energy,'ee');       otherwise                % should have caught this above, but if not...           error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   end % MULCOR.M does the actual work...   [icor,cor] = mulcor(t,k,data-bkgd,imult,pol,mu,thick,bin,bout,geo,alpha);% Show the results...warning offplot(k,cor);title('Correction factor (absorption, multiple scattering, and polarization)');gridwarning ondisp('Total correction factor; press any key to continue.');pause(.1)  plot(k,data./max(data),'--',k,icor./max(icor),'-');  title('Corrected and uncorrected scattering data')  legend('Raw data','Corrected data')  ylabel('Intensity (normalized to same arbitrary scale)')  switch PROBE      case 0                    % x-rays          xlabel('k (inv. )')      case 1                    % electrons          xlabel('s (inv. )')      otherwise           error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   end   % Convert to columns	cor=cor(:);	icor=icor(:);%----------------------------------------------------------------------function [icor,cor] = mulcor(t,k,e,imult,pol,mu,thick,bin,bout,geo,alp);% MULCOR  Multiple scattering, polarization and absorption corrections %         for experimental scattered x-ray intensity% Usage:% 	[icor,cor] = mulcor(t,k,int,imult,mon,mu,thick,bin,bout,geo,alp)%% Note that CORINT is a convenient front end to MULCOR.%% Input:% t, k  = arrays of theta (degrees) and scattering vector (1/Angstroms)% i     = array of experimental intensities (counts)% km    = k-scale for Imulti/Isingle% imult = Imulti/Isingle% pol   = polarization constant (see POLARIZATION below)% mu    = absorption coefficient in 1/cm% thick = thickness in cm% bin   = width of the primary beam in cm% bout  = width of the detected beam% alp   = inclination angle of the sample for absorption correction:%         (zero for symmetrical reflection)% geo   = sample geometry string. Possibilities:%			Reflection geometry:%				'reflthick'	Symmetric or asymmetric reflection%				'reflthin'	Symmetric reflection (weakly absorbing sample) %			Transmission geometry:%				'trans'		symmetric or asymmetric transmission geometry%				'transpart'	symmetric geometry, detector height included%				'transnorm'	transmission with incident beam perpendicular to sample%			Electron scattering:%				'tem'		electron scattering in transmission (TEM)%% Output:% 	icor  = corrected intensity% 	cor   = correction function % Todd Hufnagel (hufnagel@jhu.edu) 5-2-00% Originally by R. Serimaa% Comments and minor changes, TCH 8-20-93% TCH 5-2-00 Code clean up; multiple scattering now has same k-scale as data% 09-May-03 TCH Incorporated directly into CORINT.M; eliminated call to% PAD.M% Check which radiation we're using; x-rays (PROBE=0) are the default   global PROBE     if isempty(PROBE) PROBE=0;end   if ~((PROBE==0)|(PROBE==1))       error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   end  geo=lower(geo);c1 = ones(size(k));	% Multiple scattering correctionc2 = ones(size(k));	% Polarization correctionc3 = ones(size(k));	% Absorption correction%% Multiple scattering correction%if (isempty(imult)~=0),	c1 = multicor(k,imult);    disp('Multiple scattering correction; press any key to continue.')	plot(real(k),real(c1)),title('Multiple scattering correction'),grid,pause(.1)    ylabel('Correction factor')  switch PROBE      case 0                    % x-rays          xlabel('k (inv. )')      case 1                    % electrons          xlabel('s (inv. )')      otherwise           error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   endend%% Polarization correction%if isempty(pol)             % No polarization correction to be applied    c2=ones(size(t));       % maybe applies to TEM?else	c2 = polarization(t,pol);    disp('Polarization correction; press any key to continue.')	plot(real(k),real(c2)),title('Polarization correction'),grid,pause(.1)	ylabel('Correction factor')      switch PROBE      case 0                    % x-rays          xlabel('k (inv. )')      case 1                    % electrons          xlabel('s (inv. )')      otherwise           error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')   endend%% Absorption correction%c3 = ones(size(t));if length(geo)<9    geo=[geo blanks(9-length(geo))];endif geo(1:9) == 'reflthick',	c3=reflec(t,alp,mu,thick,bin);elseif geo(1:8) == 'reflthin',	c3=reflweak(t,mu,thick,bin,bout);elseif geo(1:9) == 'transpart',	c3=transpar(t,mu,thick,bin,bout);elseif geo(1:9) == 'transnorm',	c3=nortrans(t,mu,thick,bin);elseif geo(1:5) == 'trans',	c3=transm(t,alp,mu,thick,bin);elseif geo(1:3) == 'tem', % Assume no absorption correction for TEM for now	c3=ones(size(t));enddisp('Absorption correction; press any key to continue.')warning offplot(real(k),real(c3)),title('Absorption correction'),grid,pause(.1)warning onylabel('Correction factor')warning offswitch PROBE      case 0                    % x-rays          xlabel('k (inv. )')      case 1                    % electrons          xlabel('s (inv. )')      otherwise           error('Unknown setting of global PROBE! (Should be 0 for x-rays or 1 for electrons.)')endwarning on          %% Apply all three corrections to the data%c1=c1(:);c2=c2(:);c3=c3(:);cor = c1.*c2.*c3;icor = e.*cor;%----------------------------------------------------------------------function mul = multicor(k,i2peri1);% MULTICO  Multiple scattering correction: mul = 1/(1+i2peri1) %          use: Icorr = I * mul%% function mul = multico(k,i2peri1)% input:% k       = array of scattering vector values% i2peri1 = Imulti / Isingle% output:% mul     = array of correction functionsmul = ones(size(k))./(1+i2peri1);%----------------------------------------------------------------------function pol = polarization(theta,mon);% POLARIZATION  Polarization correction for x-ray scattering%% Usage:% 		pol = polarization(theta,mon)%% Input:%	theta   = array of angles theta in degrees% 	mon 	= monocromator constant, defined as follows:%			(1) If mon=0, then it is assumed that the incident radiation%				is unpolarized (as from a laboratory source) and that %				there is no monochromator.%			(2) If mon>0, then it is assumed that the incident radiation%			 	is unpolarized and that there is%				an exit-beam monochromator. In this case, calculate mon%				using mon=cos(2theta_mon)^2 for an ideally imperfect%				monochromator crystal, and mon=abs(cos(2theta_mon)) for%				an ideally perfect crystal (where 2theta_mon is the%				scattering angle of the monochromator).%			(3) If mon<0, then it is assumed that a synchrotron source is%				being used, with scattering in the vertical plane. In%				this case, abs(mon) is the fraction horizontal polarization%				of the synchrotron beam (usually about 0.95, but ask your%				the guru for your beamline).%% Output:% 	pol 	= array of values of polarization correction function%			  (use corrected = uncorrected * pol)%% Todd Hufnagel (hufnagel@jhu.edu) 5-2-00% Originally by R. Serimaa% Added synchrotron beam polarization, TCH 3-25-94% 09-May-03 Fixed unpolarized beam w/o monochromator bugif (mon > 0)    % Unpolarized beam with exit-beam monochromator    	pol = (1+mon)./(1.0+mon*cos(2*theta*pi/180).^2);elseif (mon==0) % Unpolarized beam, no monochromator        pol = 1./(1.0+cos(2*theta*pi/180).^2);else            % Horizontal polarization (synchrotron)	h=abs(mon);		pol = 1./(h + (1-h).*cos(2.*theta.*pi./180).^2);end%----------------------------------------------------------------------function refl = reflec(t,alpha,mu,thick,beamin);% REFLEC  Geometrical correction factor for absorption and irradiated volume;%         flat planparallel sample in reflection position.%         Use: Icorr = Imeas*refl%% refl = reflec(t,alpha,mu,thick,beamin)% input:% t      = array of angles (theta) in degrees% alpha  = inclination angle. alpha = 0 for symmetrical reflection% mu     = absorption coefficient in 1/cm% thick  = thickness of the sample in cm% beamin = width of the primary beam in cm% output:% refl   = array of values of absorption correction function% Originally by R. Serimaa% Asymmetric correction bug fixed, TCH 4-5-94j =find(t <= alpha);   if isempty(j) == 0,   refl(j) = beamin/2/mu+0*t(j);endsinplu=sin(pi/180*(t+alpha));sinmin=sin(pi/180*(t-alpha));j = find(t > alpha);if isempty(j) == 0,   refl(j) = (1.-exp(-mu*thick*(sinmin(j).^(-1)+sinplu(j).^(-1) )))...   ./(1+sinplu(j)./sinmin(j))/mu*beamin/2;endrefl=ones(size(refl))./refl;%----------------------------------------------------------------------function refl = reflweak(t,mu,thick,a,W);% REFLWEAK Absorption correction for weakly absorbing samples%% Usage: refl=reflweak(t,mu,thick,a,W)%% Correction of scattered intensity in symmetric reflection% geometry for absorption and geometrical factors when the % sample is weakly absorbing (so that the detector may see % only a portion of the irradiated volume). To apply the% correction, use Icorr=refl*Imeas.%% Input:% 	t     = array of angles (theta) in degrees% 	mu    = absorption coefficient in 1/cm% 	thick = thickness of the sample in cm% 	a     = the width (height) of the incident beam in cm% 	W     = the width (height) of the detected beam in cm%% Output:% 	refl  = array of values of correction function%% Todd Hufnagel, Johns Hopkins University (hufnagel@jhu.edu)% Originally by R. Serimaa (Dept. of Physics, Helsinki University)% TCH 5-11-00 Code clean-up, renamed routine, eliminated parafocus.m% Reference: M. E. Milberg, J. Appl. Physics (1958), 29, 64-65.w     = (W-a)/2.;  mut   = mu*thick;norm  = a/(2.*mu);alpha = 2*mu*a*sin(2*t*pi/180).^(-1);beta  = 2*mu*w*sin(2*t*pi/180).^(-1);%% Case #1%	j = find(thick > 0 & thick <= w*(2*cos(t*pi/180)).^(-1));	if isempty(j) == 0,		refl(j) = norm*(1-exp(-2*mut* sin(t(j)*pi/180).^(-1)  ));	end%% Case #2%	j = find(thick > w*(2*cos(t*pi/180)).^(-1) & ...	    thick < (a+w)*(2.*cos(t*pi/180)).^(-1));	if isempty(j) == 0,		refl(j) = norm*( (1-exp (-2*mut*sin(t(j)*pi/180).^(-1)) ) ...	         + (2*thick*cos(t(j)*pi/180)/a - w/a + alpha(j).^(-1))...	         .* exp(-2*mut*sin(t(j)*pi/180).^(-1)) ...	         - (alpha(j).^(-1)).*exp(-beta(j)));	end%% Case #3%	j = find(thick >= (a+w)*(2*cos(t*pi/180)).^(-1));	if isempty(j) == 0,		refl(j) = norm*(1-(alpha(j).^(-1)).*(1-exp(-alpha(j))).*...		exp(-beta(j)) );	endrefl=ones(size(refl))./refl;%----------------------------------------------------------------------function tran = transpar(t,mu,thick,a,w);% TRANSPAR  Geometrical correction factor for absorption and irradiated volume,%           flat planparallel sample in symmetrical transmission position and%           only a portion of the irradiated volume is detected.%           use: Icorr = tran * Iexp% % function tran = transpar(t,mu,thick,a,w);% input:% t     = array of angles (theta) in degrees% mu    = absorption coefficient in 1/cm% thick = thickness of the sample in cm% a     = the width of the incident beam in cm% w     = the width of the detected beam in cm, beamin <= beamout% output:% tran  = array of values of absorption correction function% References:%           F. Hajdu and G. Palinkas. J. Appl. Cryst. (1972), 5, 395-401.%           V. C. Wilson and J. S. Kasper. Phys. Rev. (1954), 95, 1408-1411.% Matlab 4.1 compatibility changes TCH 1-14-94sinthe = sin(t*pi/180);costhe = cos(t*pi/180);g = w*(2*thick*sinthe).^(-1);if a < w,   j = find(sinthe >= 0 & sinthe <= (w-a)/(2*thick));    g(j) = g(j)*0+1;   j = find((w-a)/(2*thick) < sinthe & sinthe <= (w+a)/(2*thick));   g(j) = (w+a-thick*sinthe(j))/(2*a)-(w-a)^2*(8*a*thick*sinthe(j)).^(-1);else   j=find(sinthe <= w/thick);    g(j) = 1-thick*sinthe(j)/(2*w);endtran = a*thick*g.*costhe.^(-1);j = find(mu*thick*costhe.^(-1) < 10000000);tran(j) = tran(j).*exp(-mu*thick*costhe(j).^(-1));tran = ones(size(tran))./tran;%----------------------------------------------------------------------function tran = nortrans(t,mu,thick,beamin);% NORTRANS  Geometrical correction factor for absorption and irradiated %           volume; flat planparallel sample in perpendicular transmission %           position%           use: Icorr = Imeas*tran % % tran = nortrans(t,mu,thick,beamin)% input:% t      = array of angles (theta) in degrees% mu     = absorption coefficient in 1/cm% thick  = thickness of the sample in cm% beamin = the width of the incident beam in cm% output:% tran   = array of values of absorption correction functioncosthe=cos(2*pi/180*t);m = length(t);tran=ones(1,m)*beamin/mu;j = find(costhe > 0 & costhe < 1);[n,m]=size(j);if m > 0,   tran(j) = ( exp(-mu*thick)-exp(-mu*thick*costhe(j).^(-1)) )...           .*(costhe(j)./(1.-costhe(j)))/mu*beamin;endtran = ones(size(tran))./tran;%----------------------------------------------------------------------function tran = transm(t,alpha,mu,thick,beamin);% TRANSM  Geometrical correction factor for absorption and irradiated volume,%         flat planparallel sample in transmission position.%         Use: Icorr = tran * Imeas% % tran   = transm(t,alpha,mu,thick,beamin)% input:% t      = array of angles (theta) in degrees% alpha  = angle of inclination %          alpha = 0 for symmetrical transmission geometry% mu     = absorption coefficient in 1/cm% thick  = thickness of the sample in cm% beamin = the width of the incident beam in cm% output:% tran   = array of values of absorption correction functioncosplu=cos(pi/180*(t+alpha));cosmin=cos(pi/180*(t-alpha));if alpha <= 0,   tran = exp(-mu*thick*cosplu.^(-1))./cosplu*thick*beamin;else   tran = ( exp(-mu*thick*cosmin.^(-1)) - exp(-mu*thick*cosplu.^(-1)) )...        ./(-1 + cosmin./cosplu)/mu*beamin;endtran = ones(size(tran))./tran;%----------------------------------------------------------------------