function [X,W] = lsqreg2(A,Y,Sigma,regfac)% LSQREG    Solving the set of equations AX=Y by means of regularized%           least squares procedure. % [X,sig] = lsqreg2(A,Y,S,regfac)% input: % A      = mxn-matrix% Y      = nx1-column % Sigma  = a weighting matrix. Typically Sigma = diag(S.^(-1)), %          where S contains variances of Y.% regfac = a regularization factor % regfun = a control parameter to choose the regularization function%          0  a unity matrix%          1  w'w where w is [-1 1 0; 0 -1 1]%          2  w'w where w is [1 -2 1]% output:% X      = solution% % wtw = eye(A'*A)% w = [-1 1 0; 0 -1 1];% w = [1 -2 1]; wtw = w'*w; [n1,n2] = size(A);%size(A)%size(Sigma) W   = A'*Sigma*A; apu = max(max(W)); W   = W/apu + regfac/n1*eye(size(W)); %%%%%%%  /sqrt(cond(W)); X   = W\(A'*Sigma*Y/apu);%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% W = A'*Sigma*A+regfac*eye(A'*A);% X = W\(A'*Sigma*Y);